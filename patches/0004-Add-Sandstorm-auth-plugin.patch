From 1b453e7df28b50d957215f941a0ca9ca09b0c1b1 Mon Sep 17 00:00:00 2001
From: Ian Denhardt <ian@zenhack.net>
Date: Thu, 19 May 2022 01:13:08 -0400
Subject: [PATCH 4/4] Add Sandstorm auth plugin.

Imported from https://github.com/PDIS/codimd-sandstorm

The plugin proper is in the sandstorm-hedgedoc repo, and we mount it
into the hedgedoc directory via sourceMap. This patch just integrates it
with other files.
---
 lib/models/user.js    | 3 +++
 lib/web/auth/index.js | 3 +++
 package.json          | 1 +
 yarn.lock             | 7 +++++++
 4 files changed, 14 insertions(+)

diff --git a/lib/models/user.js b/lib/models/user.js
index 5532e5b3..b9149e85 100644
--- a/lib/models/user.js
+++ b/lib/models/user.js
@@ -132,6 +132,9 @@ module.exports = function (sequelize, DataTypes) {
       case 'saml':
         photo = generateAvatarURL(profile.username, profile.emails[0], bigger)
         break
+      case 'sandstorm':
+        photo = profile.photo
+        break
       default:
         if (profile.emails && profile.emails.length > 0) {
           photo = generateAvatarURL(profile.username, profile.emails[0])
diff --git a/lib/web/auth/index.js b/lib/web/auth/index.js
index 86ab4b28..56dbe02f 100644
--- a/lib/web/auth/index.js
+++ b/lib/web/auth/index.js
@@ -47,6 +47,9 @@ if (config.isOAuth2Enable) authRouter.use(require('./oauth2'))
 if (config.isEmailEnable) authRouter.use(require('./email'))
 if (config.isOpenIDEnable) authRouter.use(require('./openid'))
 
+// Enable sandstorm
+authRouter.use(require('./sandstorm'))
+
 // logout
 authRouter.get('/logout', function (req, res) {
   if (config.debug && req.isAuthenticated()) {
diff --git a/package.json b/package.json
index f3099f89..afcd3963 100644
--- a/package.json
+++ b/package.json
@@ -71,6 +71,7 @@
     "mysql2": "^2.0.0",
     "node-fetch": "^2.6.1",
     "passport": "^0.5.0",
+    "passport-custom": "^1.1.1",
     "passport-dropbox-oauth2": "^1.1.0",
     "passport-facebook": "^3.0.0",
     "passport-github": "^1.1.0",
diff --git a/yarn.lock b/yarn.lock
index f454136c..f45544bb 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -7881,6 +7881,13 @@ pascalcase@^0.1.1:
   resolved "https://registry.yarnpkg.com/pascalcase/-/pascalcase-0.1.1.tgz#b363e55e8006ca6fe21784d2db22bd15d7917f14"
   integrity sha1-s2PlXoAGym/iF4TS2yK9FdeRfxQ=
 
+passport-custom@^1.1.1:
+  version "1.1.1"
+  resolved "https://registry.yarnpkg.com/passport-custom/-/passport-custom-1.1.1.tgz#71db3d7ec1d7d0085e8768507f61b26d88051c0a"
+  integrity sha512-/2m7jUGxmCYvoqenLB9UrmkCgPt64h8ZtV+UtuQklZ/Tn1NpKBeOorCYkB/8lMRoiZ5hUrCoMmDtxCS/d38mlg==
+  dependencies:
+    passport-strategy "1.x.x"
+
 passport-dropbox-oauth2@^1.1.0:
   version "1.1.0"
   resolved "https://registry.yarnpkg.com/passport-dropbox-oauth2/-/passport-dropbox-oauth2-1.1.0.tgz#77c737636e4841944dfb82dfc42c3d8ab782c10e"
-- 
2.36.1

